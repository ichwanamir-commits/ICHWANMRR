<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Personal Growth OS â€” Aurora (Final)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#07101a;
    --panel: rgba(255,255,255,0.03);
    --card:#0d1620;
    --accent:#39d49a; /* toska green */
    --accent-2:#4fd1ff;
    --muted:#94a3b8;
    --text:#e6f7ef;
    --danger:#ff6b6b;
    --radius:12px;
    font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:
    radial-gradient(800px 400px at 10% 5%, rgba(79,209,255,0.03), transparent 8%),
    linear-gradient(180deg,#03060a 0%, var(--bg) 80%); color:var(--text); -webkit-font-smoothing:antialiased}
  a{color:var(--accent-2)}
  /* Layout */
  .app{display:grid; grid-template-columns:260px 1fr 360px; gap:18px; padding:20px; min-height:100vh}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border-radius:var(--radius); padding:14px; border:1px solid rgba(255,255,255,0.03); box-shadow:0 8px 30px rgba(2,6,23,0.7)}
  /* Sidebar */
  .brand{display:flex; gap:12px; align-items:center; margin-bottom:12px}
  .logo{width:50px;height:50px;border-radius:10px;background:linear-gradient(135deg,#042428,#00343a);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--accent);font-size:18px;border:1px solid rgba(255,255,255,0.03)}
  .title{font-weight:700}
  .subtitle{font-size:12px;color:var(--muted)}
  .nav{margin-top:12px; display:flex; flex-direction:column; gap:6px}
  .nav-btn{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.02);color:var(--text);cursor:pointer;font-weight:600}
  .nav-btn.active{background:linear-gradient(90deg, rgba(57,212,154,0.06), rgba(79,209,255,0.02)); border:1px solid rgba(57,212,154,0.12); color:var(--accent)}
  .sidebar-footer{margin-top:auto; display:flex; gap:8px; align-items:center}
  .small{font-size:13px; color:var(--muted)}
  /* Main */
  .main{display:flex; flex-direction:column; gap:14px}
  .overview-row{display:flex; gap:12px}
  .stat{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}
  .num{font-weight:700;color:var(--accent);font-size:18px}
  .section-title{display:flex;justify-content:space-between;align-items:center;font-weight:700}
  /* Dashboard widgets */
  .calendar{display:grid; grid-template-columns:repeat(7,1fr); gap:8px}
  .cal-day{min-height:84px;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.02);position:relative}
  .cal-day .date{position:absolute; top:6px; right:8px; color:var(--muted); font-size:12px}
  .dots{position:absolute; left:8px; bottom:8px; display:flex; gap:6px}
  .dot{width:8px;height:8px;border-radius:50%}
  /* Right column */
  .rightcol{height:calc(100vh - 40px); overflow:auto}
  /* forms & inputs */
  input,select,textarea{width:100%;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
  label{font-size:13px;color:var(--muted)}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.primary{background:linear-gradient(90deg, rgba(57,212,154,0.06), rgba(79,209,255,0.02)); border:1px solid rgba(57,212,154,0.12); color:var(--accent)}
  .btn.fail{background:linear-gradient(90deg, rgba(255,107,107,0.04), transparent); border:1px solid rgba(255,107,107,0.08); color:var(--danger)}
  .muted{color:var(--muted)}
  /* small helpers */
  .row{display:flex;gap:8px;align-items:center}
  .tag{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px}
  /* habit grid */
  .habit-grid{display:grid; grid-auto-flow:column; gap:6px; overflow:auto; padding:6px}
  .habit-cell{width:28px;height:28px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer}
  .habit-cell.done{background:linear-gradient(90deg,var(--accent), var(--accent-2)); border:1px solid rgba(255,255,255,0.06)}
  /* responsive */
  @media(max-width:1100px){ .app{grid-template-columns:1fr; padding:12px} .rightcol{height:auto} .calendar{grid-template-columns:repeat(7,1fr)} }
</style>
</head>
<body>
<div class="app">
  <!-- SIDEBAR -->
  <aside class="card" style="display:flex;flex-direction:column">
    <div class="brand">
      <div class="logo">PG</div>
      <div>
        <div class="title">Personal Growth</div>
        <div class="subtitle small">Aurora â€¢ Lokal</div>
      </div>
    </div>

    <div class="nav" id="nav">
      <button class="nav-btn active" data-view="dashboard">Dashboard</button>
      <button class="nav-btn" data-view="tracker">Progress Tracker</button>
      <button class="nav-btn" data-view="schedule">Schedule / Missions</button>
      <button class="nav-btn" data-view="finance">Finance</button>
      <button class="nav-btn" data-view="review">Weekly Review</button>
      <button class="nav-btn" data-view="settings">Settings</button>
    </div>

    <div style="margin-top:12px">
      <div style="display:flex;gap:8px">
        <button id="addQuickBtn" class="btn primary">Quick Add</button>
        <button id="importBtn" class="btn">Import</button>
      </div>
    </div>

    <div class="sidebar-footer" style="margin-top:12px">
      <div style="flex:1">
        <div class="small muted">Local prototype â€” saved on browser</div>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main card" id="mainCard">
    <!-- Dashboard view -->
    <section id="view-dashboard">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800;font-size:18px">Dashboard â€” Progress Overview</div>
        <div class="small muted">Ringkasan cepat</div>
      </div>

      <div class="overview-row" style="margin-top:12px">
        <div class="stat">
          <div class="small muted">Total Units Practiced</div>
          <div class="num" id="statTotal">0</div>
        </div>
        <div class="stat">
          <div class="small muted">Active Skills</div>
          <div class="num" id="statSkills">0</div>
        </div>
        <div class="stat">
          <div class="small muted">Best Streak (days)</div>
          <div class="num" id="statStreak">0</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px">
        <div style="flex:1" class="card">
          <div class="section-title"><div>Progress Chart</div><div class="small muted">Total per week (last 8 weeks)</div></div>
          <canvas id="overviewChart" height="160" style="margin-top:12px"></canvas>
        </div>

        <div style="width:420px" class="card">
          <div class="section-title"><div>Mini Calendar</div><div class="small muted">Click a date</div></div>
          <div id="miniCalendar" class="calendar" style="margin-top:12px"></div>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:12px">
        <div class="card" style="flex:1">
          <div class="section-title"><div>Streaks & Achievements</div><div class="small muted">Motivation</div></div>
          <div id="achieveArea" style="margin-top:10px"></div>
        </div>
        <div class="card" style="width:320px">
          <div class="section-title"><div>Quick Stats</div><div class="small muted">Snapshot</div></div>
          <div style="margin-top:10px">
            <div class="row"><div style="flex:1"><div class="small muted">Avg per session</div><div id="avgSession" style="font-weight:700">0</div></div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Tracker view -->
    <section id="view-tracker" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800;font-size:18px">Progress Tracker</div>
        <div class="small muted">Buat / kelola kegiatan</div>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px">
        <div style="flex:1" class="card">
          <div class="section-title"><div>Activities</div><div><button class="btn primary" onclick="openCreateActivity()">+ New Activity</button></div></div>
          <div id="activitiesList" style="margin-top:10px; max-height:48vh; overflow:auto"></div>
        </div>

        <div style="width:420px" class="card">
          <div class="section-title"><div>Activity Detail</div><div class="small muted">Pilih activity untuk edit</div></div>
          <div id="activityDetail" style="margin-top:10px">Pilih kegiatan dari kiri.</div>
        </div>
      </div>
    </section>

    <!-- Schedule view -->
    <section id="view-schedule" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800;font-size:18px">Schedule & Missions</div>
        <div class="small muted">Recurring tasks & reminders</div>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px">
        <div style="flex:1" class="card">
          <div class="section-title"><div>Scheduled Items</div><div><button class="btn primary" onclick="openScheduleModal()">+ Create</button></div></div>
          <div id="schedulesList" style="margin-top:10px; max-height:60vh; overflow:auto"></div>
        </div>

        <div style="width:420px" class="card">
          <div class="section-title"><div>Day Preview</div><div class="small muted">Klik tanggal di calendar</div></div>
          <div id="scheduleDayDetail" style="margin-top:10px">Pilih tanggal di Dashboard â†’ Mini Calendar.</div>
        </div>
      </div>
    </section>

    <!-- Finance view -->
    <section id="view-finance" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800;font-size:18px">Finance</div>
        <div class="small muted">Track income & expense</div>
      </div>
      <div style="display:flex;gap:12px;margin-top:12px">
        <div style="flex:1" class="card">
          <div class="section-title"><div>Records</div><div class="small muted"></div></div>
          <div style="margin-top:10px">
            <div style="display:flex;gap:8px">
              <input id="finAmount" placeholder="amount" />
              <select id="finType"><option value="expense">Expense</option><option value="income">Income</option><option value="saving">Saving</option></select>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="finCategory" placeholder="category" />
              <button class="btn primary" id="addFinBtn">Add</button>
            </div>
            <div style="margin-top:10px; max-height:48vh; overflow:auto"><table><thead><tr><th>Date</th><th>Type</th><th>Amt</th><th>Cat</th></tr></thead><tbody id="finRecords"></tbody></table></div>
          </div>
        </div>

        <div style="width:420px" class="card">
          <div class="section-title"><div>Summary</div><div class="small muted">Monthly</div></div>
          <div style="margin-top:10px"><div class="small muted">Balance</div><div id="finBalance" style="font-weight:700;font-size:20px">0</div></div>
        </div>
      </div>
    </section>

    <!-- Weekly review -->
    <section id="view-review" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800;font-size:18px">Weekly Review</div>
        <div class="small muted">Auto draft & save</div>
      </div>

      <div style="margin-top:12px" class="card">
        <textarea id="reviewText" rows="6" style="background:transparent;padding:12px"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px"><button class="btn primary" id="genReviewBtn">Generate</button><button class="btn" id="saveReviewBtn">Export</button></div>
      </div>
    </section>

    <!-- Settings -->
    <section id="view-settings" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800;font-size:18px">Settings</div>
        <div class="small muted">Customize</div>
      </div>

      <div style="margin-top:12px" class="card">
        <label>Coach Tone</label>
        <select id="settingTone">
          <option value="partner_mix">Partner (ID+EN)</option>
          <option value="professional">Professional</option>
          <option value="motivator">Motivator</option>
        </select>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn primary" id="saveSettingsBtn">Save</button>
          <button class="btn" id="resetDataBtn">Reset Data</button>
        </div>
      </div>
    </section>
  </main>

  <!-- RIGHT COLUMN -->
  <aside class="card rightcol">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Quick Actions</div>
      <div class="small muted">Fast tools</div>
    </div>

    <div style="margin-top:12px">
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <select id="quickSkillSelect"></select>
        <input id="quickAmt" placeholder="amt" style="width:80px" />
        <button class="btn primary" id="quickAddBtn">Log</button>
      </div>

      <div style="margin-top:10px">
        <div class="small muted">Pomodoro</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="pomSkill" placeholder="skill id or choose" />
          <button class="btn primary" id="pomStartBtn">Start</button>
        </div>
        <div id="pomDisplay" class="small muted" style="margin-top:8px">Ready</div>
      </div>

      <div style="margin-top:14px">
        <div class="section-title"><div>Coach</div><div class="small muted">Partner tone</div></div>
        <div id="coachPanel" style="margin-top:8px;background:linear-gradient(90deg, rgba(57,212,154,0.03), rgba(79,209,255,0.02));padding:12px;border-radius:10px;color:var(--accent)"></div>
      </div>

      <div style="margin-top:12px">
        <div style="display:flex;gap:8px">
          <button class="btn" id="exportBtnAll">Export All</button>
          <button class="btn" id="importBtnAll">Import</button>
        </div>
      </div>
    </div>
  </aside>
</div>

<!-- modal root -->
<div id="modalRoot" style="display:none"></div>

<script>
/* ---------- App Data & Storage ---------- */
const KEY = 'pg_os_final_v1';
let DB = JSON.parse(localStorage.getItem(KEY) || JSON.stringify({
  skills: [], activities: [], logs: [], missions: [], schedules: [], finances: [], settings: { tone: 'partner_mix' }
}));
function save(){ localStorage.setItem(KEY, JSON.stringify(DB)); }

/* ---------- Utils ---------- */
function uid(){ return 'id_' + Math.random().toString(36).slice(2,9); }
function now(){ return new Date().toISOString(); }
function dateKey(d){ return (new Date(d)).toISOString().slice(0,10); }
function fmt(d){ return new Date(d).toLocaleString(); }
function el(id){ return document.getElementById(id); }

/* ---------- Init Demo Data (only if empty) ---------- */
if(DB.activities.length === 0 && DB.skills.length === 0){
  const s1 = { id: uid(), name: 'Public Speaking', color:'#39d49a' };
  const s2 = { id: uid(), name: 'English', color:'#4fd1ff' };
  DB.skills.push(s1,s2);
  DB.activities.push({ id: uid(), name: 'Practice Speech', skillId: s1.id, type: 'progress', unit:'hours', target:50, createdAt: now(), recurrence: {type:'weekly', weekdays:[1,3,5]} });
  DB.activities.push({ id: uid(), name: 'Vocabulary Drills', skillId: s2.id, type: 'habit', unit:'days', createdAt: now(), recurrence: {type:'daily'} });
  DB.logs.push({ id: uid(), activityId: DB.activities[0].id, date: new Date().toISOString(), amount:1, note:'warmup' });
  save();
}

/* ---------- DOM Refs ---------- */
const navBtns = Array.from(document.querySelectorAll('.nav-btn'));
const views = { dashboard: el('view-dashboard'), tracker: el('view-tracker'), schedule: el('view-schedule'), finance: el('view-finance'), review: el('view-review'), settings: el('view-settings') };
const overviewChartCtx = document.getElementById('overviewChart').getContext('2d');

/* ---------- Navigation ---------- */
navBtns.forEach(btn=>{
  btn.addEventListener('click', ()=> {
    navBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const view = btn.dataset.view;
    for(const k in views){ views[k].style.display = (k===view)? '' : 'none'; }
    if(view === 'dashboard') renderDashboard();
    if(view === 'tracker') renderActivities();
    if(view === 'schedule') renderSchedules();
    if(view === 'finance') renderFinances();
    if(view === 'review') renderReview();
    if(view === 'settings') renderSettings();
  });
});

/* ---------- Dashboard: Mini calendar & overview chart ---------- */
let overviewChart = null;
function renderDashboard(){
  // Stats
  el('statTotal').textContent = DB.logs.reduce((a,b)=>a+Number(b.amount||0),0);
  el('statSkills').textContent = DB.skills.length;
  el('statStreak').textContent = calcBestStreak();

  // Mini calendar (current month)
  renderMiniCalendar(new Date());

  // Overview chart: weekly totals last 8 weeks
  const weeks = [];
  const labels = [];
  for(let i=7;i>=0;i--){
    const start = new Date(); start.setDate(start.getDate() - i*7);
    const weekStart = new Date(start); weekStart.setDate(weekStart.getDate() - weekStart.getDay()); // sunday
    const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate()+6);
    labels.push(`${weekStart.getMonth()+1}/${weekStart.getDate()}`);
    const total = DB.logs.filter(l=>{
      const d = new Date(l.date); return d >= weekStart && d <= weekEnd;
    }).reduce((a,b)=>a+Number(b.amount||0),0);
    weeks.push(total);
  }
  if(overviewChart) overviewChart.destroy();
  overviewChart = new Chart(overviewChartCtx, {
    type:'bar',
    data:{ labels, datasets:[{ label:'Units', data: weeks, backgroundColor: 'rgba(57,212,154,0.8)' }]},
    options:{ plugins:{ legend:{display:false} }, scales:{ y: { beginAtZero:true } } }
  });

  // achievements preview
  renderAchievements();
}

/* Mini calendar generation + clickable dates */
function renderMiniCalendar(viewDate){
  const container = el('miniCalendar');
  container.innerHTML = '';
  const start = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
  const end = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 0);
  const startWeekday = start.getDay();
  for(let i=0;i<startWeekday;i++){
    const blank = document.createElement('div'); blank.className='cal-day'; blank.style.opacity='0.18'; container.appendChild(blank);
  }
  for(let day=1; day<=end.getDate(); day++){
    const d = new Date(viewDate.getFullYear(), viewDate.getMonth(), day);
    const key = dateKey(d);
    const cell = document.createElement('div'); cell.className='cal-day';
    cell.innerHTML = `<div class="date">${day}</div><div class="dots" id="dots_${key}"></div>`;
    cell.addEventListener('click', ()=> {
      // show day detail in scheduleDayDetail or dayDetail
      const logs = DB.logs.filter(l=> dateKey(l.date) === key);
      const occ = expandAllOccurrencesForDate(key);
      let html = `<div style="font-weight:700">${d.toDateString()}</div>`;
      html += `<div class="small muted" style="margin-top:8px">Events: ${occ.length}</div>`;
      occ.forEach(o=> html += `<div style="padding:8px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.03)"><strong>${o.title}</strong><div class="small muted">${o.type}</div></div>`);
      html += `<div class="small muted" style="margin-top:10px">Logs: ${logs.length}</div>`;
      logs.forEach(l=> html += `<div style="padding:8px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.03)"><strong>${getActivityName(l.activityId)}</strong> â€¢ ${l.amount}<div class="small">${l.note||''}</div></div>`);
      html += `<div style="margin-top:10px"><div style="font-weight:700">Quick Add</div><select id="daySkillSel">${DB.skills.map(s=>`<option value="${s.id}">${s.name}</option>`)}</select><input id="dayAmt" placeholder="amount"/><textarea id="dayNote" rows="2" placeholder="note"></textarea><div style="display:flex;gap:8px;margin-top:8px"><button class="btn primary" onclick="addLogOnDate('${key}')">Add Log</button></div></div>`;
      el('scheduleDayDetail').innerHTML = html;
      // highlight selected cell
      document.querySelectorAll('.cal-day').forEach(c=>c.style.boxShadow='none');
      cell.style.boxShadow='0 0 0 2px rgba(57,212,154,0.08)';
    });
    container.appendChild(cell);
  }
  // populate dots for events/logs
  const occMap = buildOccurrencesForMonth(viewDate);
  DB.logs.forEach(l=>{ const k=dateKey(l.date); const n = document.getElementById('dots_'+k); if(n){ const dot = document.createElement('div'); dot.className='dot'; const act = DB.activities.find(a=>a.id===l.activityId); dot.style.background = (act && act.color) ? act.color : '#39d49a'; dot.title = `${getActivityName(l.activityId)}: ${l.amount}`; n.appendChild(dot); }});
  for(const k in occMap){ const n = document.getElementById('dots_'+k); if(!n) continue; occMap[k].forEach(ev=>{ const dot = document.createElement('div'); dot.className='dot'; dot.style.background = ev.color || '#4fd1ff'; dot.title = ev.title; n.appendChild(dot); }); }
}

/* ---------- Activities (Tracker) ---------- */
function renderActivities(){
  const container = el('activitiesList');
  container.innerHTML = '';
  if(DB.activities.length===0) container.innerHTML = '<div class="small muted">No activities yet. Click + New Activity</div>';
  DB.activities.slice().reverse().forEach(act=>{
    const div = document.createElement('div'); div.style.padding='10px'; div.style.border='1px solid rgba(255,255,255,0.03)'; div.style.borderRadius='8px'; div.style.marginBottom='8px'; div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center';
    div.innerHTML = `<div style="min-width:0"><div style="font-weight:700">${act.name}</div><div class="small muted">${getSkillName(act.skillId)} â€¢ ${act.type}</div></div>
      <div style="display:flex;gap:8px;align-items:center"><button class="btn" onclick="openActivityDetail('${act.id}')">Open</button><button class="btn fail" onclick="deleteActivity('${act.id}')">Delete</button></div>`;
    container.appendChild(div);
  });
  // update quick select
  const qs = el('quickSkillSelect'); qs.innerHTML = '<option value="">â€” choose activity â€”</option>';
  DB.activities.forEach(a=> { const opt = document.createElement('option'); opt.value = a.id; opt.text = a.name; qs.appendChild(opt); });
}

/* Open activity detail (right panel) */
function openActivityDetail(id){
  const act = DB.activities.find(a=>a.id===id);
  if(!act) return;
  selectedActivity = act;
  let html = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">${act.name}</div><div class="small muted">${getSkillName(act.skillId)} â€¢ ${act.type}</div></div><div><button class="btn" onclick="openEditActivity('${act.id}')">Edit</button></div></div>`;
  // show different UI per type
  if(act.type === 'progress' || act.type === 'timeline'){
    // progress summary
    const total = DB.logs.filter(l=> l.activityId===act.id).reduce((a,b)=>a+Number(b.amount||0),0);
    const pct = act.target ? Math.round((total/act.target)*100) : 0;
    html += `<div style="margin-top:10px"><div class="small muted">Total: ${total} ${act.unit || ''}</div><div style="margin-top:8px"><div style="height:10px;background:rgba(255,255,255,0.02);border-radius:8px;"><div style="width:${clamp(pct,0,100)}%;height:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));border-radius:8px"></div></div><div class="small muted" style="margin-top:6px">${pct}% of target ${act.target || '-'}</div></div></div>`;
    // logs
    const logs = DB.logs.filter(l=>l.activityId===act.id).sort((a,b)=>new Date(b.date)-new Date(a.date));
    html += `<div style="margin-top:12px"><div class="small muted">Logs</div><table style="margin-top:8px"><thead><tr><th>Date</th><th>Amt</th><th>Note</th><th></th></tr></thead><tbody>`;
    logs.forEach(l=> html += `<tr><td>${fmt(l.date)}</td><td>${l.amount}</td><td>${l.note||''}</td><td><button class="btn" onclick="deleteLog('${l.id}')">Del</button></td></tr>`);
    html += `</tbody></table><div style="margin-top:8px"><button class="btn primary" onclick="openAddLogModal('${act.id}')">+ Add Progress</button></div></div>`;
  } else if(act.type === 'habit'){
    // habit grid: show last 30 days
    html += `<div style="margin-top:10px"><div class="small muted">Habit (last 30 days)</div><div style="margin-top:8px; display:flex; gap:6px; overflow:auto">`;
    const today = new Date();
    for(let i=29;i>=0;i--){
      const d = new Date(); d.setDate(today.getDate() - i);
      const k = dateKey(d);
      const done = DB.logs.some(l=> l.activityId===act.id && dateKey(l.date) === k);
      html += `<div class="habit-cell ${done? 'done':''}" onclick="toggleHabit('${act.id}','${k}', this)">${done? 'âœ“':''}</div>`;
    }
    html += `</div></div><div style="margin-top:10px"><button class="btn primary" onclick="markToday('${act.id}')">Mark Today</button></div>`;
  } else if(act.type === 'checklist'){
    // checklist items (stored in act.items)
    html += `<div style="margin-top:10px"><div class="small muted">Checklist</div>`;
    (act.items || []).forEach(it=> html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.03)">${it.text} <div><input type="checkbox" ${it.done? 'checked':''} onchange="toggleChecklistItem('${act.id}','${it.id}', this)"></div></div>`);
    html += `<div style="margin-top:8px"><input id="newChecklistItem" placeholder="New item"/><div style="display:flex;gap:8px;margin-top:8px"><button class="btn primary" onclick="addChecklistItem('${act.id}')">Add</button></div></div></div>`;
  }
  el('activityDetail').innerHTML = html;
}

/* ---------- Create / Edit Activity ---------- */
function openCreateActivity(){
  openModal(`<div class="modal"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">Create Activity</div><button class="btn" onclick="closeModal()">Close</button></div>
    <label>Name</label><input id="act_name" placeholder="e.g. Practice Speech">
    <label>Skill</label><select id="act_skill">${DB.skills.map(s=>`<option value="${s.id}">${s.name}</option>`).join('')}</select>
    <label>Type</label><select id="act_type"><option value="progress">Progress (hours/points)</option><option value="habit">Habit (daily checkbox)</option><option value="checklist">Checklist</option><option value="timeline">Timeline / Milestone</option></select>
    <div id="typeOpts" style="margin-top:8px"></div>
    <label>Color (hex)</label><input id="act_color" placeholder="#39d49a">
    <div style="display:flex;gap:8px;margin-top:10px"><button class="btn primary" onclick="submitCreateActivity()">Create</button><button class="btn" onclick="closeModal()">Cancel</button></div>
  </div>`);
  document.getElementById('act_type').addEventListener('change', ()=> { const v = document.getElementById('act_type').value; const opts = el('typeOpts'); if(v==='progress' || v==='timeline'){ opts.innerHTML = `<label>Unit</label><input id="act_unit" placeholder="hours"><label>Target (numeric)</label><input id="act_target" type="number">`; } else if(v==='checklist'){ opts.innerHTML = `<label>Initial items (comma separated)</label><input id="act_items" placeholder="item1,item2">`; } else if(v==='habit'){ opts.innerHTML = `<label>Default recurrence</label><select id="act_recur"><option value="daily">Daily</option><option value="weekly">Weekly</option></select>`; } else opts.innerHTML=''; });
}
function submitCreateActivity(){
  const name = el('act_name').value; if(!name) return alert('Name required');
  const skillId = el('act_skill').value; const type = el('act_type').value; const color = el('act_color').value || '#39d49a';
  const base = { id: uid(), name, skillId, type, color, createdAt: now(), recurrence: null };
  if(type==='progress' || type==='timeline'){ base.unit = el('act_unit')?.value || 'hours'; base.target = Number(el('act_target')?.value) || 0; }
  if(type==='checklist'){ const raw = el('act_items')?.value || ''; base.items = raw.split(',').map(s=>({ id: uid(), text: s.trim(), done:false})).filter(x=>x.text); }
  if(type==='habit'){ const r = el('act_recur')?.value || 'daily'; base.recurrence = { type: r }; }
  DB.activities.push(base); save(); closeModal(); renderActivities(); openActivityDetail(base.id);
}

/* Edit & delete */
function openEditActivity(id){
  const a = DB.activities.find(x=>x.id===id); if(!a) return;
  openModal(`<div class="modal"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">Edit Activity</div><button class="btn" onclick="closeModal()">Close</button></div>
    <label>Name</label><input id="edit_name" value="${a.name}">
    <label>Color</label><input id="edit_color" value="${a.color || ''}">
    <div style="display:flex;gap:8px;margin-top:8px"><button class="btn primary" onclick="submitEditActivity('${a.id}')">Save</button><button class="btn" onclick="closeModal()">Cancel</button></div>
  </div>`);
}
function submitEditActivity(id){ const a = DB.activities.find(x=>x.id===id); a.name = el('edit_name').value || a.name; a.color = el('edit_color').value || a.color; save(); closeModal(); renderActivities(); openActivityDetail(id); }
function deleteActivity(id){ if(confirm('Delete activity?')){ DB.activities = DB.activities.filter(x=>x.id!==id); DB.logs = DB.logs.filter(l=>l.activityId!==id); save(); renderActivities(); el('activityDetail').innerHTML='Pilih kegiatan dari kiri.'; } }

/* ---------- Logs (add/delete) ---------- */
function openAddLogModal(actId){
  openModal(`<div class="modal"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">Add Progress</div><button class="btn" onclick="closeModal()">Close</button></div>
    <label>Date & Time</label><input id="lg_date" type="datetime-local" value="${new Date().toISOString().slice(0,16)}">
    <label>Amount</label><input id="lg_amount" type="number">
    <label>Note</label><textarea id="lg_note" rows="3"></textarea>
    <div style="display:flex;gap:8px;margin-top:8px"><button class="btn primary" onclick="submitAddLog('${actId}')">Add</button><button class="btn" onclick="closeModal()">Cancel</button></div>
  </div>`);
}
function submitAddLog(actId){
  const date = el('lg_date').value; const amount = Number(el('lg_amount').value); const note = el('lg_note').value;
  if(!amount) return alert('Amount required'); DB.logs.push({ id: uid(), activityId: actId, date: new Date(date).toISOString(), amount, note }); save(); closeModal(); renderActivities(); openActivityDetail(actId); renderDashboard();
}
function deleteLog(id){ if(confirm('Delete log?')){ DB.logs = DB.logs.filter(x=>x.id!==id); save(); renderActivities(); renderDashboard(); } }

/* Habit toggles */
function toggleHabit(activityId, dateKeyStr, elCell){
  const existed = DB.logs.find(l=> l.activityId===activityId && dateKey(l.date) === dateKeyStr);
  if(existed){ DB.logs = DB.logs.filter(l=> !(l.activityId===activityId && dateKey(l.date) === dateKeyStr)); save(); elCell.classList.remove('done'); } else { DB.logs.push({ id: uid(), activityId, date: dateKeyStr + 'T12:00:00', amount:1 }); save(); elCell.classList.add('done'); }
}
function markToday(activityId){ const key = dateKey(new Date()); if(DB.logs.some(l=> l.activityId===activityId && dateKey(l.date)===key)) return alert('Already marked today'); DB.logs.push({ id: uid(), activityId, date: key + 'T12:00:00', amount:1 }); save(); openActivityDetail(activityId); renderDashboard(); }

/* Checklist */
function addChecklistItem(activityId){
  const a = DB.activities.find(x=>x.id===activityId); const text = el('newChecklistItem').value; if(!text) return alert('Enter item'); a.items = a.items || []; a.items.push({ id: uid(), text, done:false }); save(); openActivityDetail(activityId);
}
function toggleChecklistItem(activityId, itemId, checkbox){
  const a = DB.activities.find(x=>x.id===activityId); const item = a.items.find(i=>i.id===itemId); item.done = checkbox.checked; save(); openActivityDetail(activityId);
}

/* ---------- Schedules / Recurrence handling ---------- */
function openScheduleModal(){
  openModal(`<div class="modal"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">Create Scheduled Item</div><button class="btn" onclick="closeModal()">Close</button></div>
    <label>Title</label><input id="sch_title">
    <label>Start (datetime)</label><input id="sch_start" type="datetime-local" value="${new Date().toISOString().slice(0,16)}">
    <label>Recurrence</label><select id="sch_recur" onchange="toggleScheduleOpts()"><option value="none">None</option><option value="daily">Daily</option><option value="weekly">Weekly (choose days)</option><option value="biweekly">Bi-weekly</option><option value="monthly_date">Monthly (date)</option><option value="custom_every_n_days">Custom (every N days)</option></select>
    <div id="sch_opts" style="margin-top:8px"></div>
    <label>End condition</label><select id="sch_end" onchange="toggleScheduleEnd()"><option value="never">Never</option><option value="until">Until date</option><option value="after">After occurrences</option></select>
    <div id="sch_end_opts" style="margin-top:8px"></div>
    <div style="margin-top:8px;display:flex;gap:8px"><button class="btn primary" onclick="submitSchedule()">Create</button><button class="btn" onclick="closeModal()">Cancel</button></div>
  </div>`);
  setTimeout(()=>{ toggleScheduleOpts(); toggleScheduleEnd(); },50);
}
function toggleScheduleOpts(){
  const v = el('sch_recur').value; const o = el('sch_opts');
  if(v==='weekly'){ o.style.display='block'; o.innerHTML = `<div class="small muted">Weekdays</div><div style="display:flex;gap:6px;margin-top:6px">${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map((d,i)=>`<label style="display:flex;align-items:center;gap:6px"><input type="checkbox" class="sch_wd" value="${i}">${d}</label>`).join('')}</div>`; }
  else if(v==='custom_every_n_days'){ o.style.display='block'; o.innerHTML = `<label class="small">Every N days</label><input id="sch_every_n" type="number" placeholder="e.g. 3">`; }
  else o.style.display='none', o.innerHTML='';
}
function toggleScheduleEnd(){
  const v = el('sch_end').value; const oe = el('sch_end_opts');
  if(v==='until'){ oe.style.display='block'; oe.innerHTML = `<label class="small">Until date</label><input id="sch_end_date" type="date">`; }
  else if(v==='after'){ oe.style.display='block'; oe.innerHTML = `<label class="small">Occurrences</label><input id="sch_end_after" type="number" placeholder="e.g. 10">`; }
  else oe.style.display='none', oe.innerHTML='';
}
function submitSchedule(){
  const title = el('sch_title').value; if(!title) return alert('Title required');
  const start = el('sch_start').value; const recur = el('sch_recur').value;
  const s = { id: uid(), title, start: start || null, recurrence: recur };
  if(recur==='weekly'){ s.weekdays = Array.from(document.querySelectorAll('.sch_wd:checked')).map(c=>Number(c.value)); }
  if(recur==='custom_every_n_days'){ s.every_n_days = Number(el('sch_every_n')?.value) || 1; }
  const endCond = el('sch_end').value; if(endCond==='until'){ s.recurrence_end = el('sch_end_date')?.value; } else if(endCond==='after'){ s.end_after = Number(el('sch_end_after')?.value) || null; }
  DB.schedules.push(s); save(); closeModal(); renderSchedules(); renderDashboard();
}
function renderSchedules(){
  const container = el('schedulesList'); container.innerHTML = '';
  if(DB.schedules.length===0) container.innerHTML = '<div class="small muted">No schedules yet</div>';
  DB.schedules.slice().reverse().forEach(s=>{
    const div = document.createElement('div'); div.style.padding='10px'; div.style.border='1px solid rgba(255,255,255,0.03)'; div.style.borderRadius='8px'; div.style.marginBottom='8px';
    div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${s.title}</strong><div class="small muted">${s.recurrence || 'none'}</div></div><div><button class="btn" onclick="deleteSchedule('${s.id}')">Delete</button></div></div>`;
    container.appendChild(div);
  });
}
function deleteSchedule(id){ if(confirm('Delete schedule?')){ DB.schedules = DB.schedules.filter(s=>s.id!==id); save(); renderSchedules(); renderDashboard(); } }

/* Expand occurrences for a given month (used for calendar) */
function buildOccurrencesForMonth(view){
  const map = {};
  const start = new Date(view.getFullYear(), view.getMonth(), 1); const end = new Date(view.getFullYear(), view.getMonth()+1, 0);
  const rangeStart = new Date(start.getFullYear(), start.getMonth(), 1,0,0,0); const rangeEnd = new Date(end.getFullYear(), end.getMonth(), end.getDate(),23,59,59);
  DB.schedules.forEach(sch=>{
    const occs = expandOccurrences(sch, rangeStart, rangeEnd);
    occs.forEach(dt=>{ const k = dateKey(dt); map[k] = map[k] || []; map[k].push({ type:'schedule', title: sch.title, color:'#4fd1ff' }); });
  });
  DB.missions.forEach(ms=>{
    if(ms.recurrence && ms.recurrence!=='none'){ const occs = expandOccurrences(ms, rangeStart, rangeEnd); occs.forEach(dt=>{ const k=dateKey(dt); map[k]=map[k]||[]; map[k].push({ type:'mission', title:ms.title, color:'#ffd166' }); }); }
    else if(ms.due){ const d = new Date(ms.due); if(d>=rangeStart && d<=rangeEnd){ const k=dateKey(d); map[k]=map[k]||[]; map[k].push({ type:'mission', title:ms.title, color:'#ffd166' }); } }
  });
  return map;
}
function expandOccurrences(item, rangeStart, rangeEnd){
  const occs=[]; const type = item.recurrence || 'none';
  if(type==='none'){ if(item.start){ const d=new Date(item.start); if(d>=rangeStart && d<=rangeEnd) occs.push(d); } return occs; }
  const start = item.start ? new Date(item.start) : new Date();
  const endCond = item.recurrence_end ? new Date(item.recurrence_end) : null;
  const maxEnd = endCond || rangeEnd;
  let cur = new Date(start);
  const pushIfIn = d=>{ if(d>=rangeStart && d<=rangeEnd) occs.push(new Date(d)); };
  if(type==='daily'){ while(cur<=maxEnd){ pushIfIn(cur); cur.setDate(cur.getDate()+1); if(occs.length>500) break; } }
  else if(type==='weekly'){ const w = item.weekdays || [cur.getDay()]; while(cur<=maxEnd){ if(w.includes(cur.getDay())) pushIfIn(cur); cur.setDate(cur.getDate()+1); if(occs.length>500) break; } }
  else if(type==='biweekly'){ const interval = 14; while(cur<=maxEnd){ pushIfIn(cur); cur.setDate(cur.getDate()+interval); if(occs.length>500) break; } }
  else if(type==='monthly_date'){ const dom = cur.getDate(); while(cur<=maxEnd){ pushIfIn(cur); cur.setMonth(cur.getMonth()+1); if(cur.getDate()!==dom) cur.setDate(Math.min(dom, new Date(cur.getFullYear(), cur.getMonth()+1,0).getDate())); if(occs.length>500) break; } }
  else if(type==='custom_every_n_days'){ const n = item.every_n_days || 1; while(cur<=maxEnd){ pushIfIn(cur); cur.setDate(cur.getDate()+n); if(occs.length>500) break; } }
  if(item.end_after) return occs.slice(0, item.end_after);
  return occs;
}

/* For day preview: gather events + missions */
function expandAllOccurrencesForDate(key){
  const result = [];
  const dStart = new Date(key+'T00:00:00'), dEnd = new Date(key+'T23:59:59');
  DB.schedules.forEach(sch=>{ if(expandOccurrences(sch, dStart, dEnd).length) result.push({ title: sch.title, type:'schedule' }); });
  DB.missions.forEach(ms=>{ if(ms.recurrence && ms.recurrence!=='none'){ if(expandOccurrences(ms, dStart, dEnd).length) result.push({ title: ms.title, type:'mission' }); } else if(ms.due && dateKey(ms.due)===key) result.push({ title: ms.title, type:'mission' }); });
  return result;
}

/* ---------- Finance ---------- */
function renderFinances(){
  const tbody = el('finRecords'); tbody.innerHTML = '';
  DB.finances.slice().reverse().forEach(f=>{
    const tr = document.createElement('tr'); tr.innerHTML = `<td>${new Date(f.date).toLocaleDateString()}</td><td>${f.type}</td><td>${f.amount}</td><td>${f.category}</td>`;
    tbody.appendChild(tr);
  });
  const bal = DB.finances.reduce((a,b)=> a + (b.type==='income'? b.amount : b.type==='expense'? -b.amount : 0), 0);
  el('finBalance').textContent = bal;
}
el('addFinBtn').addEventListener('click', ()=> {
  const amt = Number(el('finAmount').value); const type = el('finType').value; const cat = el('finCategory').value || 'misc';
  if(!amt) return alert('Enter amount'); DB.finances.push({ id: uid(), date: now(), amount: amt, type, category: cat }); save(); renderFinances(); el('finAmount').value=''; el('finCategory').value='';
});

/* ---------- Review ---------- */
el('genReviewBtn').addEventListener('click', ()=> {
  const last7 = DB.logs.filter(l=> new Date(l.date) > new Date(Date.now() - 7*24*3600*1000));
  const byAct = {};
  last7.forEach(l=> byAct[l.activityId] = (byAct[l.activityId]||0) + Number(l.amount||0));
  let txt = `Weekly Review (${new Date().toLocaleDateString()}):\n`;
  for(const k in byAct){ txt += `- ${getActivityName(k)}: ${byAct[k]}\n`; }
  txt += `Missions completed: ${DB.missions.filter(m=>m.status==='completed').length}`;
  el('reviewText').value = txt;
});
el('saveReviewBtn').addEventListener('click', ()=> {
  const blob = new Blob([el('reviewText').value], { type:'text/plain' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `weekly_review_${new Date().toISOString().slice(0,10)}.txt`; a.click(); URL.revokeObjectURL(url);
});

/* ---------- Settings ---------- */
function renderSettings(){ el('settingTone').value = DB.settings.tone || 'partner_mix'; }
el('saveSettingsBtn').addEventListener('click', ()=> { DB.settings.tone = el('settingTone').value; save(); alert('Settings saved'); renderCoachPanel(); });
el('resetDataBtn').addEventListener('click', ()=> { if(confirm('Reset local data? This will erase everything.')){ localStorage.removeItem(KEY); location.reload(); } });

/* ---------- Export / Import ---------- */
el('exportBtnAll').addEventListener('click', ()=> {
  const blob = new Blob([JSON.stringify(DB,null,2)], { type:'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'pg_os_export.json'; a.click(); URL.revokeObjectURL(url);
});
el('importBtnAll').addEventListener('click', ()=> { openModal(`<div class="modal"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">Import DB</div><button class="btn" onclick="closeModal()">Close</button></div><textarea id="imp_txt" rows="10" style="background:transparent"></textarea><div style="display:flex;gap:8px;margin-top:8px"><button class="btn primary" onclick="submitImportAll()">Import</button><button class="btn" onclick="closeModal()">Cancel</button></div></div>`); });
function submitImportAll(){ try{ const data = JSON.parse(el('imp_txt').value); DB = data; save(); closeModal(); renderAllViews(); alert('Imported'); } catch(e){ alert('Invalid JSON'); } }
el('importBtn').addEventListener('click', ()=> { openModal(`<div class="modal"><div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:800">Import (short)</div><button class="btn" onclick="closeModal()">Close</button></div><textarea id="imp_short" rows="8" style="background:transparent"></textarea><div style="display:flex;gap:8px;margin-top:8px"><button class="btn primary" onclick="submitImportShort()">Import</button><button class="btn" onclick="closeModal()">Cancel</button></div></div>`); });
function submitImportShort(){ try{ const data = JSON.parse(el('imp_short').value); DB = data; save(); closeModal(); renderAllViews(); alert('Imported'); } catch(e){ alert('Invalid JSON'); } }

/* ---------- Quick Add ---------- */
el('quickAddBtn').addEventListener('click', ()=> {
  const aid = el('quickSkillSelect').value; const amt = Number(el('quickAmt').value); if(!aid||!amt) return alert('Choose activity and amount'); DB.logs.push({ id: uid(), activityId: aid, date: now(), amount: amt, note:'quick' }); save(); renderAllViews(); el('quickAmt').value='';
});

/* ---------- Pomodoro ---------- */
let pomTimer = null;
el('pomStartBtn').addEventListener('click', ()=> {
  if(pomTimer){ clearInterval(pomTimer); pomTimer = null; el('pomDisplay').textContent = 'Stopped'; return; }
  let sec = 25*60; el('pomDisplay').textContent = formatSeconds(sec);
  pomTimer = setInterval(()=> { sec--; el('pomDisplay').textContent = formatSeconds(sec); if(sec<=0){ clearInterval(pomTimer); pomTimer=null; el('pomDisplay').textContent = 'Session done!'; const sk = el('pomSkill').value; if(sk){ // try to find activity by name or id
      const act = DB.activities.find(a=> a.id===sk || a.name.toLowerCase()===sk.toLowerCase()); if(act){ DB.logs.push({ id: uid(), activityId: act.id, date: now(), amount:25, note:'pomodoro' }); save(); renderAllViews(); } } } }, 1000);
});
function formatSeconds(s){ const m = Math.floor(s/60); const sec = s%60; return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; }

/* ---------- Achievements ---------- */
function renderAchievements(){
  const area = el('achieveArea'); area.innerHTML = '';
  // sample achievements: total logs milestones
  const total = DB.logs.reduce((a,b)=>a+Number(b.amount||0),0);
  const milestones = [10,50,100,200,500];
  const unlocked = milestones.filter(m=> total >= m);
  unlocked.forEach(m=>{
    const d = document.createElement('div'); d.style.padding='8px'; d.style.border='1px solid rgba(255,255,255,0.03)'; d.style.borderRadius='8px'; d.style.marginTop='8px'; d.innerHTML = `<strong>Milestone ${m}</strong><div class="small muted">Total units reached ${m}</div>`; area.appendChild(d);
  });
  if(unlocked.length===0) area.innerHTML = '<div class="small muted">No achievements yet â€” keep going!</div>';
}

/* ---------- Helpers ---------- */
function getSkillName(id){ return DB.skills.find(s=>s.id===id)?.name || 'â€”'; }
function getActivityName(id){ return DB.activities.find(a=>a.id===id)?.name || 'â€”'; }
function calcBestStreak(){
  if(!DB.logs.length) return 0;
  const daySet = Array.from(new Set(DB.logs.map(l=> new Date(l.date).toDateString())));
  daySet.sort((a,b)=> new Date(a)-new Date(b));
  let best=0, cur=1;
  for(let i=1;i<daySet.length;i++){ const diff = (new Date(daySet[i]) - new Date(daySet[i-1])) / (1000*60*60*24); if(diff===1) cur++; else cur=1; best = Math.max(best, cur); }
  return Math.max(best, cur);
}

/* ---------- Modal helper ---------- */
function openModal(html){ const root = el('modalRoot'); root.style.display = 'block'; root.innerHTML = `<div class="modal-backdrop">${html}</div>`; }
function closeModal(){ const root = el('modalRoot'); root.style.display = 'none'; root.innerHTML = ''; }

/* ---------- Small functions used by injected HTML ---------- */
window.openCreateActivity = openCreateActivity;
window.openAddLogModal = openAddLogModal;
window.openEditActivity = openEditActivity;
window.deleteActivity = deleteActivity;
window.deleteLog = deleteLog;
window.addLogOnDate = function(key){
  const activityId = el('daySkillSel').value; const amt = Number(el('dayAmt').value); const note = el('dayNote').value;
  if(!activityId || !amt) return alert('Choose activity & amount');
  DB.logs.push({ id: uid(), activityId, date: key + 'T12:00:00', amount: amt, note }); save(); renderAllViews(); openModal('<div class="modal"><div style="padding:12px">Added âœ… <div style="margin-top:8px"><button class="btn" onclick="closeModal()">Close</button></div></div></div>'); };
window.openScheduleModal = openScheduleModal;

/* ---------- Toggle habit & checklist functions need global binding ---------- */
window.toggleHabit = toggleHabit;
window.markToday = markToday;
window.addChecklistItem = addChecklistItem;
window.toggleChecklistItem = toggleChecklistItem;

/* ---------- Helpers for rendering all views ---------- */
function renderAllViews(){ renderActivities(); renderDashboard(); renderSchedules(); renderFinances(); renderCoachPanel(); }
function renderCoachPanel(){ el('coachPanel').textContent = generateCoach(); }
function generateCoach(){ const t = DB.settings.tone || 'partner_mix'; const templates = {
  partner_mix: [`Sayang, aku bangga banget liat usaha kamu hari ini. Little steps, big changes ðŸ’š`, `Babe, kamu udah bekerja keras â€” peluk dulu, terus lanjut ya. Aku di sini.`],
  professional: [`Progress recorded. Maintain consistency.`, `Good job. Plan next steps.`],
  motivator: [`Legend! Keep pushing, you got this!`, `Power mode on â€” smash the targets!`]
}; const arr = templates[t] || templates.partner_mix; return arr[Math.floor(Math.random()*arr.length)]; }

/* ---------- Initial render ---------- */
renderAllViews();
renderCoachPanel();

/* Ensure initial active view is dashboard */
document.querySelector('.nav-btn[data-view="dashboard"]').click();
</script>
</body>
</html>
